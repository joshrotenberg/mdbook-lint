#!/bin/sh
#
# Pre-commit hook for mdbook-lint
# This hook runs the essential checks before committing
#

set -e

echo "ğŸ” Running pre-commit checks..."

# 1. Format check
echo "ğŸ“ Checking code formatting..."
if ! cargo fmt --all -- --check; then
    echo "âŒ Code formatting check failed. Please run 'cargo fmt --all' to fix."
    exit 1
fi

# 2. Clippy check
echo "ğŸ”§ Running clippy..."
if ! cargo clippy --all-targets --all-features -- -D warnings; then
    echo "âŒ Clippy found issues. Please fix them before committing."
    exit 1
fi

# 3. Unit tests
echo "ğŸ§ª Running unit tests..."
if ! cargo test --lib --all-features; then
    echo "âŒ Unit tests failed. Please fix them before committing."
    exit 1
fi

# 4. Integration tests
echo "ğŸ”¬ Running integration tests..."
if ! cargo test --test '*' --all-features; then
    echo "âŒ Integration tests failed. Please fix them before committing."
    exit 1
fi

# 5. Doc tests
echo "ğŸ“š Running doc tests..."
if ! cargo test --doc --all-features; then
    echo "âŒ Doc tests failed. Please fix them before committing."
    exit 1
fi

# Check for Claude Code signatures (as mentioned in CLAUDE.md)
if git diff --cached --name-only | xargs grep -l "Generated with Claude Code" 2>/dev/null; then
    echo "âŒ Found 'Generated with Claude Code' signature in staged files. Please remove it."
    exit 1
fi

# Check for emojis (as mentioned in CLAUDE.md)
if git diff --cached --name-only | xargs grep -l "[\u1F600-\u1F64F\u1F300-\u1F5FF\u1F680-\u1F6FF\u1F1E0-\u1F1FF\u2600-\u26FF\u2700-\u27BF]" 2>/dev/null; then
    echo "âŒ Found emojis in staged files. Please remove them."
    exit 1
fi

echo "âœ… All pre-commit checks passed!"